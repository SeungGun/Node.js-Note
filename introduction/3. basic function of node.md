<h2> 노드의 기본 기능</h2>

<hr>
<h3>1. 주소 문자열과 요청 파라미터</h3>

- 웹 사이트를 접속할 때, 사이트 주소를 이용하여 접속하고, 각 웹 사이트의 페이지는 특정 데이터에 대한 웹 페이지를 보여준다. (특정 단어 검색, 마이페이지, 상품 정보 등등)
- 그러한 정보들을 요청할 때 사용하는 주소들에는 특정 규칙이 있다. 

`https://www.example.com/?latitude=120&longitude=35&output=json`

- 위와 같은 주소가 있으면 

  `https`은 protocol

  `www.example.com`은 host

  ※ 요청 파라미터(request parameter)라고 해서 주소에 parameter를 전달을 그 parameter에 대한 결과를 웹 사이트(서버)에 요청하는 것이다.

  이를 query라고 해서 어떤 질문을 할 것인지에 대한 정보로써 `?`로 구분한다. 

  그리고 요청 파라미터들은 `&`로 구분되어서 요청된다. 

  `latitude=120&longitude=35&output=json`이 query

  - 그 중 3개의 request parameter가 `&`로 구분되어서 전달된다. 

- 웹 사이트에 접속하기 위한 사이트 주소는 Node.js에서 URL 객체로 만들 수 있다.
- 웹 사이트에서 접속하는 사이트 주소는 단순 문자열이기 때문에, 어디까지가 사이트 주소인지, 어떤 내용이 요청 파라미터인지 구별해야 한다. 
- 구별하기 위해 **?** 기호를 앞에 문자열과 뒤에 있는 문자열을 분리한다. 
  - ? 앞 : 사이트 주소
  - ? 뒤 : 요청 파라미터



- 그래서 위와 같은 작업을 쉽게할 수 있도록 "url 모듈"이 존재한다. 

- 이 **url 모듈**을 이용하여 주소 문자열과 URL 객체간의 변환하는 작업이 용이하게 된다. 

```
https://www.google.co.kr/?gws_rd=ssl#newwindow=1&q=actor
						|
					url 모듈
						|
					URL 객체 
{protocol:https, host:www.google.co.kr, query:gws_rd=ssl#newwindow=1&q=actor}
```

- 주소 문자열을 URL 객체로 만들어서 그 문자열을 각각의 정보로 나누어 객체의 속성으로 보관한다. 

> 주소 문자열 <-> URL 객체 변환하기

`parse()` : 주소 문자열 to URL 객체로 변환

`format()` : URL 객체 to 주소 문자열로 변환



> 요청 파라미터(request parameter) 확인하기

- **querystring** 모듈을 이용한다. 

`parse()` : 요청 파라미터 문자열을 객체로 변환해줌

`stringify()` : 객체안에 들어 있는 요청 파라미터를 문자열을 변환해줌 



<hr>

<h3> 2. 이벤트 (Event)</h3>

- Node.js는 Event를 기반으로 비동기 방식으로 처리를 한다. 

> 이벤트 : 한쪽에서 다른 쪽으로 어떤 "일"이 발생했다는 것을 알리는 것(알림 메세지)
>
> 다른 쪽에서 이벤트를 받고 싶다면 Event Listener를 등록할 수 있다. 
>
> Event Listener는 "특정한" 이벤트가 전달되었을 때, 그 이벤트를 처리할 수 있도록 만든 것이다.  

- Async 방식으로 처리하기 위해 서로 이벤트를 전달한다. 

  → 함수의 결과물도 이벤트로 전달할 수 있다.

- "이러한 일이 발생했다", "이쪽 상태가 이렇다" 라는 정보를 다른쪽으로 **알림 메세지**를 보내는 형식과 비슷하다. 



- 이렇게 이벤트를 전달하고 받을 수 있도록 **EventEmitter**라는 것이 만들어져 있어 이를 이용한다. 

- EventEmitter를 객체가 상속을 받아서, 이벤트를 등록하고, 전달하는 기능을 사용할 수 있다. 

<h4>간략한 이벤트의 동작 과정</h4>

```
이벤트를 이벤트 리스너에 콜백 함수를 등록해놓고, 
특정 시점에 그 이벤트가 발생하면, 리스너가 그 이벤트를 감지하여(전달받아)
리스너에 등록해놓은 콜백 함수가 실행되어 전달 받은 이벤트를 처리 한다.
```

- 미리 정의되어 있는 이벤트

```javascript
console.log('시작');

process.on('exit', function(){
    console.log('exit 이벤트 발생');
});

setTimeout(function(){
    console.log('2초 후 시스템 종료 시도함');
    
    process.exit();
}, 2000);

console.log('끝');
```

- process 객체는 자동으로 EventEmitter를 상속받았기 때문에, `on()`과 `emit()`를 바로 사용할 수 있다.
- process 객체의 `on()` 메소드로 이벤트 이름을 'exit'로 등록하면 프로세스가 끝나는 시점을 알 수 있다. (exit() 메소드가 내부적으로 이벤트를 호출한다)

1. "시작" 로그 출력
2. process 객체가 'exit' 이벤트 등록
3. setTimeout()함수 호출로 2초 기다리는 중
4. "끝" 로그 출력
5. 2초가 다 지나고 setTimeout() 함수의 콜백 함수 호출
6. 로그 출력
7. process.exit() 메소드 실행하면서 'exit' 이벤트 발생
8. 'exit' 이벤트를 전달받아 'exit' 이벤트의 리스너 콜백 함수 호출
9. 로그 출력

**노드 환경은 무언가 기다리는 작업 혹은 콜백 함수는 비동기로 처리되기 때문에 실행 순서가 달라진다.** 

- 사용자 정의 이벤트

```javascript
process.on('tick', function(count){
    console.log('tick 이벤트 발생 : %d',count);
});
var cnt = 0 ;

setTimeout(function(){
	console.log('2초후에 tick 이벤트 전달 시도함');
    
    process.emit('tick',++cnt); // process가 tick 이벤트를 호출
    process.emit('tick',++cnt); // process가 tick 이벤트를 호출

}, 2000);
```

1. 2초후에, setTimeout()의 콜백 함수 호출
2. 로그 출력
3. 첫번째 'tick' 이벤트 발생
4. 'tick'이벤트 리스너의 콜백 함수 호출
5. 로그로 cnt 값 1 출력
6. 두번째 'tick' 이벤트 발생
7. 'tick' 이벤트 리스너의 콜백 함수 호출
8. 로그로 cnt 값 2 출력

<hr>

<h3> EventEmitter 객체 생성 </h3>

1. `events` 모듈 불러오기

```javascript
var EventEmitter = require('events')
```

2. `EventEmitter` 객체 생성하기

```javascript
var a = EventEmitter.EventEmitter(); // 첫번째 방법
var b = new proceess.EventEmitter(); // 두번째 방법
```

```javascript
var EventEmitter = require('events').EventEmitter(); // 한번에 가져오기
```



<h3>EventEmitter를 상속하도록 하기</h3>

1. `util` 모듈 불러오기

```javascript
var util = require('util');
```

2. 특정 객체가 `EventEmitter` 상속하기 

```javascript
var EventEmitter = require('events').EventEmitter();
var Object = {...};
util.inherits(Object, EventEmitter);
```



<h3>이벤트 연결하기 (리스너 등록)</h3>

- `on()` 메소드  or `once()` 메소드 를 이용하여 parameter로 지정한 이벤트에 대한 리스너를 추가한다. 

`on(event, listener)`, `once(event, listener)`  

- **event**는 특정 이벤트를 구분하는 **문자열 이벤트 이름**이다. 

- **listener**는 위의 **event**가 발생했을 때 실행되는 "리스너 함수"로, 이벤트를 받아 처리하는 함수를 의미한다.

※ once 메소드는 최초 한번 실행되고 나서는 자동으로 리스너가 제거된다. (일회성)

- 기본적으로 **EventEmitter**는 특정 이벤트에 대해 10개 이상의 리스너가 등록되면 `Memory leak`을 막는 것을 돕기 위해 경고 메세지를 출력한다

<h4>EventEmitter 관련 메소드</h4>

| method                           | 설명                                    |
| -------------------------------- | --------------------------------------- |
| emitter.setMaxListener(n)        | 특정 개수의 리스너를 등록하기 위함      |
| emitter.listenerCount(eventName) | eventName에 등록된 리스너의 개수를 리턴 |
| emitter.listener(eventName)      | eventName에 등록된 리스너 배열을 리턴   |



<h3>이벤트 삭제하기</h3>

- `removeListener()` 메소드를 이용하여, parameter로 지정된 event와 listener에 대한 이벤트를 제거한다.

`removeListener(event, listener)`

- **event**이라는 이벤트를 제거한다. 



<h3>이벤트 호출하기</h3>

- `emit()` 메소드를 이용하여, parameter로 전달되는 이벤트 이름에 대한 이벤트를 발생시킨다. 

`emit(event, [args])` 

- 순서대로 각 리스너를 등록된 이벤트에 맞게 호출한다. 
- event라는 이름의 이벤트를 강제로 호출하여(발생시켜) 그 이벤트가 등록된 리스너 함수를 호출한다.  `이벤트가 발생했네? 리스너가 발생한 이벤트를 listen하여 콜백 함수를 실행`
- `on()` 메소드로 등록한 리스너 함수의 parameter에 맞게 `emit()` 메소드의 두번째 parameter에 전달을 해야한다.



```javascript
var EventEmitter = require('events').EventEmitter;
var util = require('util');

var Person = function(name){
    this.name = name;
    this.on('event1', function(a, b){
        console.log(a+b);
    });
}

util.inherits(Person, EventEmitter); // EventEmitter를 상속

setTimeout(function(){
	var person1 = new Person('gildong');
    person1.emit('event1', 10, 20);
}, 2000);

```

1. Person 프로토타입 객체가 EventEmitter를 상속 받음 (이로써, on(), emit() 사용 가능)
2. 2초후에 `setTimeout()` 함수의 콜백 함수를 실행
3. Person 프로토타입 객체의 인스턴스 `person1` 생성
4. `person1` 객체가 `emit()` 메소드로 `'event1'`이라는 이벤트를 10과 20과 함께 전달
5. Person 프로토타입 객체에서 등록해놓은 이벤트 리스너의 콜백 함수 실행 (this.on(...)) 
6. 10과 20의 합인 30을 출력

